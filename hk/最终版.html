<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ’è°·ç®¡ç†ç³»ç»Ÿï¼ˆæœ¬åœ°ç‰ˆï¼‰</title>
    <style>
        /* å…¨å±€é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1500px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #666;
        }
        .tab.active {
            color: #2c3e50;
            border-bottom: 2px solid #2c3e50;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .upload-btn, .search-btn, .pai-gu-search-btn {
            background-color: #007bff;
            color: white;
        }
        .upload-btn:hover, .search-btn:hover, .pai-gu-search-btn:hover {
            background-color: #0056b3;
        }
        .reset-search-btn, .pai-gu-reset-btn {
            background-color: #6c757d;
            color: white;
            margin-left: 10px;
        }
        .reset-search-btn:hover, .pai-gu-reset-btn:hover {
            background-color: #5a6268;
        }
        .export-btn {
            background-color: #28a745;
            color: white;
            margin-right: 10px;
        }
        .export-btn:hover {
            background-color: #218838;
        }
        .add-new-row-btn {
            background-color: #17a2b8;
            color: white;
            margin-right: 10px;
        }
        .add-new-row-btn:hover {
            background-color: #138496;
        }
        .clear-all-btn {
            background-color: #dc3545;
            color: white;
        }
        .clear-all-btn:hover {
            background-color: #c82333;
        }
        /* ç­›é€‰æŒ‰é’®æ ·å¼ */
        .filter-btn {
            background-color: #ffc107;
            color: #212529;
            margin-left: 10px;
        }
        .filter-btn:hover {
            background-color: #e0a800;
        }
        .filter-btn.active {
            background-color: #fd7e14;
            color: white;
        }
        /* ä¸Šä¼ é¡µé¢æ ·å¼ */
        .upload-container {
            margin-top: 20px;
        }
        .upload-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .upload-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
        }
        .upload-tab.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }
        .upload-panel {
            display: none;
        }
        .upload-panel.active {
            display: block;
        }
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 600px;
        }
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group.label-top {
            width: 100%;
        }
        .batch-tips {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
            border-left: 3px solid #007bff;
        }
        .batch-textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
            resize: vertical;
        }
        /* ç¼–è¾‘é¡µé¢æ ·å¼ */
        .edit-page-container {
            margin-top: 20px;
        }
        .edit-tips {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }
        .edit-sub-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .edit-sub-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
        }
        .edit-sub-tab.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }
        .edit-sub-panel {
            display: none;
        }
        .edit-sub-panel.active {
            display: block;
        }
        .edit-table-wrap {
            overflow-x: auto;
            margin-top: 15px;
        }
        .edit-guzi-table {
            width: 100%;
            border-collapse: collapse;
        }
        .edit-guzi-table th, .edit-guzi-table td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            text-align: left;
        }
        .edit-guzi-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .edit-guzi-table td input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .col-select {
            width: 50px;
            text-align: center;
        }
        .col-category {
            min-width: 120px;
        }
        .col-img {
            min-width: 200px;
        }
        .col-price, .col-total-quantity, .col-surplus, .col-total-price {
            width: 100px;
            text-align: right;
        }
        .col-kunxu {
            width: 80px;
        }
        .col-claimer {
            min-width: 150px;
        }
        /* ç»“ç®—ç»Ÿè®¡é¡µé¢æ ·å¼ */
        .search-container {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        .search-input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 300px;
        }
        #summary-container {
            margin-top: 20px;
        }
        .summary-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }
        .summary-card h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        .summary-total {
            margin-top: 10px;
            font-weight: bold;
            font-size: 16px;
            color: #dc3545;
        }
        /* åº“å­˜å¡ç‰‡ç¿»è½¬æ ·å¼ */
        .stock-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding: 10px;
        }
        .stock-card {
            perspective: 1000px;
            height: 450px;
            cursor: pointer;
            display: none; /* é»˜è®¤éšè—ï¼Œæ ¹æ®ç­›é€‰/æœç´¢æ˜¾ç¤º */
        }
        .stock-card.visible {
            display: block; /* ç¬¦åˆæ¡ä»¶çš„æ˜¾ç¤º */
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-radius: 12px;
        }
        .stock-card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .card-front {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
        }
        .card-front::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #28a745);
        }
        .stock-card.out-of-stock .card-front::before {
            background: linear-gradient(90deg, #dc3545, #ffc107);
        }
        .card-front img {
            width: 180px;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin: 15px auto;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .card-front .category-name {
            font-weight: 600;
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-front .stock-num {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
            color: #28a745;
        }
        .stock-card.out-of-stock .card-front .stock-num {
            color: #dc3545;
            text-decoration: line-through;
        }
        .card-front .stock-status {
            font-size: 14px;
            color: #6c757d;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
            margin-top: 8px;
        }
        .stock-card.out-of-stock .card-front .stock-status {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        .card-front .kunxu-tag {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            padding: 2px 8px;
            background-color: #007bff;
            color: white;
            border-radius: 12px;
        }
        .card-front .price-info {
            margin-top: 8px;
            font-size: 16px;
            color: #007bff;
            font-weight: 600;
        }
        .card-back {
            background: #fff;
            border: 1px solid #dee2e6;
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 30px 20px;
        }
        .card-back h3 {
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .claim-form-group {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .claim-form-group label {
            font-weight: 500;
            color: #666;
            font-size: 14px;
        }
        .claim-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .claim-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        .quantity-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .quantity-tip {
            font-size: 12px;
            color: #999;
            text-align: right;
        }
        .claim-btn {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        .claim-btn:hover {
            background-color: #0056b3;
        }
        .claim-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-btn:hover {
            background-color: #e9ecef;
        }
        /* åº“å­˜æ€»é‡‘é¢ç»Ÿè®¡å¡ç‰‡ */
        .stock-total-card {
            padding: 15px;
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8fb 100%);
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
            text-align: center;
        }
        .stock-total-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .stock-total-amount {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        /* åº“å­˜é¡µé¢æœç´¢ç­›é€‰æ  */
        .stock-search-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .stock-search-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        /* å…¨å±€å¿«é€Ÿæ·»åŠ æŒ‰é’® */
        .quick-add-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            font-size: 24px;
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 999;
        }
        .quick-add-btn:hover {
            background-color: #218838;
        }
        /* åŒæ­¥æç¤º */
        .sync-tip {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border-radius: 4px;
            z-index: 1000;
            display: none;
        }
    </style>
    <!-- å¼•å…¥SheetJSåº“ç”¨äºExcelå¯¼å‡º -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
        <div class="tabs">
            <button class="tab" onclick="switchPage('upload-page')">ä¸Šä¼ è°·å­</button>
            <button class="tab" onclick="switchPage('edit-page')">ç¼–è¾‘æ’è°·æ•°æ®</button>
            <button class="tab" onclick="switchPage('summary-page')">ç»“ç®—ç»Ÿè®¡</button>
            <button class="tab active" onclick="switchPage('stock-page')">åº“å­˜ä½™é‡ï¼ˆæ–°ç‰ˆæ’è°·ï¼‰</button>
        </div>

        <!-- ä¸Šä¼ è°·å­é¡µé¢ -->
        <div id="upload-page" class="page">
            <h2>ä¸Šä¼ è°·å­ä¿¡æ¯</h2>
            <div class="upload-container">
                <div class="upload-tabs">
                    <button class="upload-tab active" onclick="switchUploadTab('single')">å•ä¸ªæ·»åŠ </button>
                    <button class="upload-tab" onclick="switchUploadTab('batch')">æ‰¹é‡ç²˜è´´æ·»åŠ </button>
                </div>
                <div id="single-upload-panel" class="upload-panel active">
                    <form class="upload-form" id="guziUploadForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="category">å“ç±»</label>
                                <input type="text" id="category" placeholder="å¾½ç« Aã€ç«‹ç‰ŒB" required>
                            </div>
                            <div class="form-group">
                                <label for="price">å•ä»·(å…ƒ)</label>
                                <input type="number" id="price" step="0.01" min="0" placeholder="15ã€35.5" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="totalQuantity">æ€»æ•°é‡</label>
                                <input type="number" id="totalQuantity" min="1" placeholder="5ã€10" required>
                            </div>
                            <div class="form-group">
                                <label for="kunxu">æ†åºï¼ˆé€‰å¡«ï¼‰</label>
                                <input type="text" id="kunxu" placeholder="æ†1ã€æ†2ï¼Œç©ºç™½=ä¸æ†">
                            </div>
                        </div>
                        <div class="form-group label-top">
                            <label for="imgUrl">è°·å­å›¾ç‰‡URLï¼ˆå¯é€‰ï¼Œç•™ç©ºç”¨é»˜è®¤å›¾ï¼‰</label>
                            <input type="text" id="imgUrl" placeholder="https://xxx.jpg">
                        </div>
                        <button type="submit" class="btn upload-btn">æ·»åŠ åˆ°æ’è°·åˆ—è¡¨</button>
                    </form>
                </div>
                <div id="batch-upload-panel" class="upload-panel">
                    <div class="batch-tips">
                        ğŸ’¡ æ‰¹é‡æ·»åŠ æ ¼å¼è¯´æ˜ï¼š<br>
                        1. æ¯è¡Œä¸€æ¡æ•°æ®ï¼Œåˆ—ä¹‹é—´ç”¨ã€åˆ¶è¡¨ç¬¦(Tab)ã€‘åˆ†éš”ï¼ˆç›´æ¥å¤åˆ¶Excelè¡Œå³å¯ï¼‰<br>
                        2. åˆ—é¡ºåºï¼šå“ç±»	å•ä»·	æ€»æ•°é‡	æ†åºï¼ˆé€‰å¡«ï¼‰	å›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰<br>
                        3. ç¤ºä¾‹ï¼š<br>
                        å¾½ç« A	15	5	æ†1	https://via.placeholder.com/80<br>
                        ç«‹ç‰ŒB	35.5	10		<!-- ç©ºç™½è¡¨ç¤ºä¸æ† -->
                        æŒ‚ä»¶C	20	8			<!-- æ†åºå’Œå›¾ç‰‡éƒ½ç•™ç©º -->
                    </div>
                    <textarea class="batch-textarea" id="batchData" placeholder="è¯·ç²˜è´´æ‰¹é‡æ•°æ®ï¼ˆæ”¯æŒç›´æ¥å¤åˆ¶Excelå†…å®¹ï¼‰"></textarea>
                    <button class="btn upload-btn" onclick="batchAddGuzi()">æ‰¹é‡æ·»åŠ åˆ°æ’è°·åˆ—è¡¨</button>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘æ’è°·æ•°æ®é¡µé¢ -->
        <div id="edit-page" class="page">
            <div class="edit-page-container">
                <h2>ç¼–è¾‘æ’è°·æ•°æ®</h2>
                <div class="edit-tips">
                    ğŸ’¡ æ“ä½œæç¤ºï¼š1. ç‚¹å‡»å•å…ƒæ ¼å¯ç›´æ¥ç¼–è¾‘ï¼›2. æ”¯æŒä»Excelå¤åˆ¶å†…å®¹ç›´æ¥ç²˜è´´åˆ°è¡¨æ ¼ï¼›3. å“ç±»æ€»ä»·ä¼šæ ¹æ®å•ä»·å’Œæ€»æ•°é‡è‡ªåŠ¨è®¡ç®—ï¼›4. å‰©ä½™æ•°é‡ä¼šæ ¹æ®æ’çš„äººCNæ•°é‡è‡ªåŠ¨è®¡ç®—ï¼›5. æ’çš„äººCNæ”¯æŒç¼–è¾‘ï¼ˆå¤šä¸ªåå­—ç”¨é¡¿å·åˆ†éš”ï¼‰ï¼›6. æ‰€æœ‰ä¿®æ”¹ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼›7. å¯åˆ é™¤å•è¡Œæ•°æ®æˆ–æ¸…ç©ºæ‰€æœ‰æ•°æ®
                </div>
                <div class="edit-sub-tabs">
                    <button class="edit-sub-tab active" onclick="switchEditSubTab('table-edit')">è¡¨æ ¼ç¼–è¾‘</button>
                    <button class="edit-sub-tab" onclick="switchEditSubTab('batch-claim')">æ‰¹é‡è®¤é¢†å¯¼å…¥</button>
                </div>
                <div id="table-edit-panel" class="edit-sub-panel active">
                    <button class="btn export-btn" onclick="exportGuziDataToExcel()">å¯¼å‡ºæ’è°·æ•°æ®ä¸ºExcel</button>
                    <button class="btn add-new-row-btn" onclick="addNewEditRow()">æ–°å¢ä¸€è¡Œ</button>
                    <button class="btn clear-all-btn" onclick="clearAllGuziDataWithExport()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                    <div class="edit-table-wrap">
                        <table id="edit-guzi-table" class="edit-guzi-table">
                            <thead>
                                <tr>
                                    <th class="col-select"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" disabled></th>
                                    <th class="col-category">å“ç±»</th>
                                    <th class="col-img">è°·å­å›¾ç‰‡URL</th>
                                    <th class="col-price">å•ä»·</th>
                                    <th class="col-total-quantity">æ€»æ•°é‡</th>
                                    <th class="col-surplus">å‰©ä½™æ•°é‡</th>
                                    <th class="col-total-price">å“ç±»æ€»ä»·</th>
                                    <th class="col-kunxu">æ†åº</th>
                                    <th class="col-claimer">æ’çš„äººCN</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="edit-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <!-- é‡æ„åçš„æ‰¹é‡è®¤é¢†å¯¼å…¥é¢æ¿ -->
                <div id="batch-claim-panel" class="edit-sub-panel">
                    <div class="pai-gu-batch-container">
                        <h3 style="margin-bottom: 10px; color: #2c3e50; font-size: 16px;">æ‰¹é‡å¯¼å…¥æ’è°·è®¤é¢†æ•°æ®</h3>
                        
                        <!-- æ–°å¢ï¼šå¯¼å…¥æ–¹å¼é€‰æ‹© -->
                        <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            <div style="font-weight: 500; margin-bottom: 8px;">ğŸ“Œ æ¨èå¯¼å…¥æ–¹å¼ï¼š</div>
                            <ol style="margin-left: 20px; line-height: 1.6; color: #666;">
                                <li>å…ˆå¯¼å‡ºExcelæ¨¡æ¿ â†’ å¡«å†™æ•°æ® â†’ å¤åˆ¶Excelå†…å®¹ç²˜è´´åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†</li>
                                <li>æ”¯æŒä¸¤ç§åˆ†éš”ç¬¦ï¼š<strong>åˆ¶è¡¨ç¬¦ï¼ˆExcelé»˜è®¤ï¼‰</strong> æˆ– <strong>é€—å·/ç«–çº¿ï¼ˆ|ï¼‰</strong></li>
                                <li>åˆ—é¡ºåºï¼šå“ç±»,å•ä»·,æ€»æ•°é‡,å‰©ä½™æ•°é‡,å“ç±»æ€»ä»·,æ†åº,æ’çš„äººCN,å›¾ç‰‡URLï¼ˆæ€»ä»·å’Œå‰©ä½™æ•°é‡ä¼šè‡ªåŠ¨è®¡ç®—ï¼‰</li>
                            </ol>
                        </div>
                        
                        <!-- ä¼˜åŒ–ï¼šæ–‡æœ¬æ¡†+æ ¼å¼é€‰æ‹© -->
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                            <label style="font-weight: 500;">åˆ†éš”ç¬¦ç±»å‹ï¼š</label>
                            <select id="delimiterType" class="btn" style="padding: 6px 12px;">
                                <option value="tab">åˆ¶è¡¨ç¬¦ï¼ˆExcelå¤åˆ¶ï¼‰</option>
                                <option value="comma">é€—å·ï¼ˆ,ï¼‰</option>
                                <option value="pipe">ç«–çº¿ï¼ˆ|ï¼‰</option>
                            </select>
                        </div>
                        
                        <textarea class="batch-textarea" id="paiGuBatchData" placeholder="è¯·ç²˜è´´æ•°æ®ï¼ˆæ”¯æŒExcelå¤åˆ¶/æ‰‹åŠ¨è¾“å…¥ï¼‰
ç¤ºä¾‹1ï¼ˆåˆ¶è¡¨ç¬¦ï¼‰ï¼šå¾½ç« A	15	5	3	75	æ†1	å¼ ä¸‰ã€æå››	https://xxx.jpg
ç¤ºä¾‹2ï¼ˆé€—å·ï¼‰ï¼šå¾½ç« B,35.5,10,8,355,ä¸æ†,ç‹äº”,
ç¤ºä¾‹3ï¼ˆç«–çº¿ï¼‰ï¼šæŒ‚ä»¶C|20|8|8|160|ä¸æ†||"></textarea>
                        
                        <!-- æ–°å¢ï¼šå¯¼å…¥é¢„è§ˆåŒºåŸŸ -->
                        <div id="importPreview" style="margin: 15px 0; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; display: none;">
                            <div style="background: #e9ecef; padding: 8px 12px; font-weight: 500; border-bottom: 1px solid #ddd;">
                                å¯¼å…¥é¢„è§ˆï¼ˆç‚¹å‡»è¡Œå¯æŸ¥çœ‹è¯¦æƒ…ï¼‰
                            </div>
                            <div id="previewTable"></div>
                        </div>
                        
                        <!-- æ–°å¢ï¼šæ“ä½œæŒ‰é’®ç»„ -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn upload-btn" onclick="previewImportData()">ğŸ“‹ é¢„è§ˆæ•°æ®</button>
                            <button class="btn export-btn" onclick="exportImportTemplate()">ğŸ“¥ ä¸‹è½½å¯¼å…¥æ¨¡æ¿</button>
                            <button class="btn" style="background: #28a745; color: white;" onclick="confirmImportData()">âœ… ç¡®è®¤å¯¼å…¥</button>
                            <button class="btn reset-search-btn" onclick="clearImportData()">ğŸ—‘ï¸ æ¸…ç©ºå†…å®¹</button>
                        </div>
                        
                        <!-- æ–°å¢ï¼šé”™è¯¯æç¤ºåŒºåŸŸ -->
                        <div id="importErrorTips" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»“ç®—ç»Ÿè®¡é¡µé¢ -->
        <div id="summary-page" class="page">
            <h2>ä¸ªäººç»“ç®—ç»Ÿè®¡</h2>
            <div class="search-container">
                <input type="text" class="search-input" id="cnSearchInput" placeholder="è¯·è¾“å…¥è¦æŸ¥è¯¢çš„CNåç§°">
                <button class="btn search-btn" onclick="searchCN()">æœç´¢</button>
                <button class="btn reset-search-btn" onclick="resetSearch()">é‡ç½®</button>
            </div>
            <div id="summary-container"></div>
        </div>

        <!-- æ–°ç‰ˆåº“å­˜ä½™é‡+æ’è°·é¡µé¢ -->
        <div id="stock-page" class="page active">
            <h2>åº“å­˜ä½™é‡ï¼ˆç‚¹å‡»å¡ç‰‡è®¤é¢†è°·å­ï¼‰</h2>
            <div class="stock-search-filter">
                <input type="text" class="stock-search-input" id="stockSearchInput" placeholder="æœç´¢å“ç±»/æ†åº...">
                <button class="btn search-btn" onclick="searchStock()">æœç´¢</button>
                <button class="btn reset-search-btn" onclick="resetStockSearch()">é‡ç½®</button>
                <button class="btn filter-btn" id="filterAllBtn" onclick="filterStock('all')">å…¨éƒ¨</button>
                <button class="btn filter-btn active" id="filterInStockBtn" onclick="filterStock('inStock')">æœ‰åº“å­˜</button>
                <button class="btn filter-btn" id="filterOutOfStockBtn" onclick="filterStock('outOfStock')">å·²å”®ç½„</button>
            </div>
            <div id="stock-total-card" class="stock-total-card">
                <h3>åº“å­˜è°·å­æ€»é‡‘é¢</h3>
                <div class="stock-total-amount">Â¥0.00</div>
            </div>
            <div id="stock-container" class="stock-container"></div>
        </div>
    </div>

    <!-- å…¨å±€å¿«é€Ÿæ·»åŠ æŒ‰é’® -->
    <button class="quick-add-btn" onclick="quickAddGuzi()">+</button>
    
    <!-- åŒæ­¥æç¤º -->
    <div class="sync-tip" id="syncTip">æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ï¼</div>
    
    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let guziData = [];          
        let claimRecords = [];      
        const defaultImgUrl = "https://via.placeholder.com/180";
        let currentSearchCN = '';   
        let currentStockFilter = 'inStock'; 
        let currentStockSearch = '';
        let importPreviewData = []; // å¯¼å…¥é¢„è§ˆæ•°æ®ç¼“å­˜
        let importErrors = [];      // å¯¼å…¥é”™è¯¯ä¿¡æ¯

        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromLocalStorage();
            
            document.getElementById('guziUploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addGuziFromForm();
            });
            
            initEditPageData();
            renderStockPage();
            renderSummaryPage();
            
            document.getElementById('cnSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchCN();
            });
            
            document.getElementById('stockSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchStock();
            });
        });

        // ==================== æœ¬åœ°å­˜å‚¨æ ¸å¿ƒå‡½æ•° ====================
        function loadDataFromLocalStorage() {
            try {
                const savedGuziData = localStorage.getItem('guziData');
                const savedClaimRecords = localStorage.getItem('claimRecords');
                
                guziData = savedGuziData ? JSON.parse(savedGuziData) : [];
                claimRecords = savedClaimRecords ? JSON.parse(savedClaimRecords) : [];
                
                console.log("âœ… ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®æˆåŠŸ");
            } catch (error) {
                console.error("âŒ åŠ è½½æœ¬åœ°æ•°æ®å¼‚å¸¸ï¼š", error);
                guziData = [];
                claimRecords = [];
            }
        }

        function clearLocalStorageData() {
            try {
                localStorage.removeItem('guziData');
                localStorage.removeItem('claimRecords');
                guziData = [];
                claimRecords = [];
                initEditPageData();
                renderStockPage();
                renderSummaryPage();
                console.log("âœ… æœ¬åœ°å­˜å‚¨æ•°æ®å·²æ¸…ç©º");
                alert("æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼");
            } catch (error) {
                console.error("âŒ æ¸…ç©ºæœ¬åœ°æ•°æ®å¼‚å¸¸ï¼š", error);
                alert("æ¸…ç©ºæœ¬åœ°æ•°æ®å¤±è´¥ï¼");
            }
        }

        function saveDataToLocalStorage() {
            try {
                localStorage.setItem('guziData', JSON.stringify(guziData));
                localStorage.setItem('claimRecords', JSON.stringify(claimRecords));
                showSyncTip();
                console.log("âœ… æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨");
            } catch (error) {
                console.error("âŒ ä¿å­˜æœ¬åœ°æ•°æ®å¼‚å¸¸ï¼š", error);
                alert("ä¿å­˜æœ¬åœ°æ•°æ®å¤±è´¥ï¼");
            }
        }

        // ==================== è¾…åŠ©å‡½æ•° ====================
        function showSyncTip() {
            const tip = document.getElementById('syncTip');
            tip.style.display = "block";
            setTimeout(() => tip.style.display = "none", 2000);
        }

        // ==================== é¡µé¢åˆ‡æ¢å‡½æ•° ====================
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
        }

        function switchUploadTab(tabType) {
            document.querySelectorAll('.upload-panel').forEach(panel => panel.classList.remove('active'));
            document.querySelectorAll('.upload-tab').forEach(tab => tab.classList.remove('active'));
            
            if (tabType === 'single') {
                document.getElementById('single-upload-panel').classList.add('active');
            } else {
                document.getElementById('batch-upload-panel').classList.add('active');
            }
            event.target.classList.add('active');
        }

        function switchEditSubTab(tabType) {
            document.querySelectorAll('.edit-sub-panel').forEach(panel => panel.classList.remove('active'));
            document.querySelectorAll('.edit-sub-tab').forEach(tab => tab.classList.remove('active'));
            
            if (tabType === 'table-edit') {
                document.getElementById('table-edit-panel').classList.add('active');
            } else {
                document.getElementById('batch-claim-panel').classList.add('active');
            }
            event.target.classList.add('active');
        }

        // ==================== ä¸Šä¼ è°·å­åŠŸèƒ½ ====================
        function addGuziFromForm() {
            const category = document.getElementById('category').value.trim();
            const price = parseFloat(document.getElementById('price').value);
            const totalQuantity = parseInt(document.getElementById('totalQuantity').value);
            const kunxu = document.getElementById('kunxu').value.trim();
            const imgUrl = document.getElementById('imgUrl').value.trim();
            
            if (!category || isNaN(price) || isNaN(totalQuantity) || totalQuantity < 1) {
                alert('è¯·å¡«å†™æ­£ç¡®çš„è°·å­ä¿¡æ¯ï¼');
                return;
            }
            
            const exists = guziData.some(item => item.category === category);
            if (exists) {
                alert(`å“ç±»ã€${category}ã€‘å·²å­˜åœ¨ï¼Œè¯·ä¿®æ”¹å“ç±»åç§°ï¼`);
                return;
            }
            
            guziData.push({
                category,
                price,
                totalQuantity,
                kunxu: kunxu || 'ä¸æ†',
                imgSrc: imgUrl || defaultImgUrl,
                claimers: [],
                stock: totalQuantity
            });
            
            saveDataToLocalStorage();
            renderStockPage();
            initEditPageData();
            
            document.getElementById('guziUploadForm').reset();
            alert(`è°·å­ã€${category}ã€‘æ·»åŠ æˆåŠŸï¼`);
        }

        function batchAddGuzi() {
            const batchData = document.getElementById('batchData').value.trim();
            if (!batchData) {
                alert('è¯·ç²˜è´´æ‰¹é‡æ•°æ®ï¼');
                return;
            }
            
            const lines = batchData.split('\n');
            let successCount = 0;
            let existsCount = 0;
            
            lines.forEach(line => {
                const parts = line.split('\t').map(part => part.trim());
                if (parts.length < 3) return;
                
                const category = parts[0];
                const price = parseFloat(parts[1]);
                const totalQuantity = parseInt(parts[2]);
                const kunxu = parts[3] || 'ä¸æ†';
                const imgUrl = parts[4] || defaultImgUrl;
                
                if (!category || isNaN(price) || isNaN(totalQuantity) || totalQuantity < 1) {
                    return;
                }
                
                if (guziData.some(item => item.category === category)) {
                    existsCount++;
                    return;
                }
                
                guziData.push({
                    category, price, totalQuantity, kunxu, imgSrc: imgUrl, claimers: [], stock: totalQuantity
                });
                successCount++;
            });
            
            if (successCount > 0) {
                saveDataToLocalStorage();
                renderStockPage();
                initEditPageData();
                const msg = `æ‰¹é‡æ·»åŠ æˆåŠŸï¼å…±æ·»åŠ ${successCount}æ¡è°·å­æ•°æ®` + (existsCount > 0 ? `ï¼Œ${existsCount}æ¡å“ç±»å·²å­˜åœ¨è·³è¿‡` : '');
                alert(msg);
                document.getElementById('batchData').value = '';
            } else {
                alert(existsCount > 0 ? 'æ‰€æœ‰å“ç±»éƒ½å·²å­˜åœ¨ï¼' : 'æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥æ ¼å¼ï¼');
            }
        }

        // ==================== ç¼–è¾‘é¡µé¢åŠŸèƒ½ ====================
        function initEditPageData() {
            const tbody = document.getElementById('edit-table-body');
            tbody.innerHTML = '';
            
            document.getElementById('selectAllCheckbox').disabled = guziData.length === 0;
            
            if (guziData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:20px; color:#666;">æš‚æ— æ•°æ®</td></tr>`;
                return;
            }
            
            guziData.forEach((item, index) => {
                const claimedCount = item.claimers ? item.claimers.length : 0;
                const stock = item.totalQuantity - claimedCount;
                const totalPrice = (item.price * item.totalQuantity).toFixed(2);
                const claimersText = item.claimers ? item.claimers.join('ã€') : '';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-select"><input type="checkbox" class="row-checkbox" data-index="${index}"></td>
                    <td class="col-category" contenteditable="true" onblur="updateEditData(${index}, 'category', this.innerText)">${item.category}</td>
                    <td class="col-img" contenteditable="true" onblur="updateEditData(${index}, 'imgSrc', this.innerText)">${item.imgSrc || defaultImgUrl}</td>
                    <td class="col-price" contenteditable="true" onblur="updateEditData(${index}, 'price', parseFloat(this.innerText))">${item.price.toFixed(2)}</td>
                    <td class="col-total-quantity" contenteditable="true" onblur="updateEditData(${index}, 'totalQuantity', parseInt(this.innerText))">${item.totalQuantity}</td>
                    <td class="col-surplus">${stock}</td>
                    <td class="col-total-price">${totalPrice}</td>
                    <td class="col-kunxu" contenteditable="true" onblur="updateEditData(${index}, 'kunxu', this.innerText)">${item.kunxu}</td>
                    <td class="col-claimer" contenteditable="true" onblur="updateEditClaimers(${index}, this.innerText)">${claimersText}</td>
                    <td><button class="btn clear-all-btn" onclick="deleteEditRow(${index})">åˆ é™¤</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateEditData(index, key, value) {
            if (value === undefined || value === null) return;
            
            if (key === 'price' && (isNaN(value) || value < 0)) {
                alert('å•ä»·å¿…é¡»æ˜¯å¤§äºç­‰äº0çš„æ•°å­—ï¼');
                document.querySelector(`#edit-table-body tr:nth-child(${index+1}) .col-${key}`).innerText = guziData[index][key].toFixed(2);
                return;
            }
            
            if (key === 'totalQuantity' && (isNaN(value) || value < 1)) {
                alert('æ€»æ•°é‡å¿…é¡»æ˜¯å¤§äº0çš„æ•´æ•°ï¼');
                document.querySelector(`#edit-table-body tr:nth-child(${index+1}) .col-${key}`).innerText = guziData[index][key];
                return;
            }
            
            guziData[index][key] = value;
            
            if (key === 'price' || key === 'totalQuantity') {
                const totalPrice = (guziData[index].price * guziData[index].totalQuantity).toFixed(2);
                document.querySelector(`#edit-table-body tr:nth-child(${index+1}) .col-total-price`).innerText = totalPrice;
            }
            
            saveDataToLocalStorage();
            renderStockPage();
            renderSummaryPage();
        }

        function updateEditClaimers(index, value) {
            const claimers = value ? value.split('ã€').map(name => name.trim()).filter(name => name) : [];
            guziData[index].claimers = claimers;
            
            const stock = guziData[index].totalQuantity - claimers.length;
            document.querySelector(`#edit-table-body tr:nth-child(${index+1}) .col-surplus`).innerText = stock;
            
            saveDataToLocalStorage();
            renderStockPage();
            renderSummaryPage();
        }

        function deleteEditRow(index) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤å“ç±»ã€${guziData[index].category}ã€‘å—ï¼Ÿ`)) {
                guziData.splice(index, 1);
                saveDataToLocalStorage();
                initEditPageData();
                renderStockPage();
                renderSummaryPage();
            }
        }

        function addNewEditRow() {
            guziData.push({
                category: 'æ–°å“ç±»',
                price: 0,
                totalQuantity: 1,
                kunxu: 'ä¸æ†',
                imgSrc: defaultImgUrl,
                claimers: [],
                stock: 1
            });
            saveDataToLocalStorage();
            initEditPageData();
            renderStockPage();
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        // ==================== å…¨æ–°é‡æ„ï¼šæ‰¹é‡è®¤é¢†å¯¼å…¥åŠŸèƒ½ ====================
        // 1. é¢„è§ˆå¯¼å…¥æ•°æ®ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰
        function previewImportData() {
            const batchData = document.getElementById('paiGuBatchData').value.trim();
            const delimiterType = document.getElementById('delimiterType').value;
            const previewContainer = document.getElementById('importPreview');
            const previewTable = document.getElementById('previewTable');
            const errorTips = document.getElementById('importErrorTips');
            
            // é‡ç½®çŠ¶æ€
            importPreviewData = [];
            importErrors = [];
            previewTable.innerHTML = '';
            errorTips.style.display = 'none';
            
            if (!batchData) {
                errorTips.style.display = 'block';
                errorTips.style.background = '#fff3cd';
                errorTips.style.color = '#856404';
                errorTips.innerHTML = 'âš ï¸ è¯·å…ˆç²˜è´´å¯¼å…¥æ•°æ®ï¼';
                return;
            }
            
            // 1. é€‰æ‹©åˆ†éš”ç¬¦
            let delimiter = '\t'; // é»˜è®¤åˆ¶è¡¨ç¬¦
            if (delimiterType === 'comma') delimiter = ',';
            if (delimiterType === 'pipe') delimiter = '|';
            
            // 2. è§£ææ•°æ®
            const lines = batchData.split('\n').filter(line => line.trim()); // è¿‡æ»¤ç©ºè¡Œ
            if (lines.length === 0) {
                errorTips.style.display = 'block';
                errorTips.style.background = '#fff3cd';
                errorTips.style.color = '#856404';
                errorTips.innerHTML = 'âš ï¸ æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®è¡Œï¼';
                return;
            }
            
            // 3. é€è¡Œè§£æå¹¶æ ¡éªŒ
            lines.forEach((line, lineNum) => {
                const rowNum = lineNum + 1;
                const parts = line.split(delimiter).map(part => part.trim());
                
                // åŸºç¡€æ•°æ®æå–ï¼ˆå…¼å®¹ä¸åŒåˆ—æ•°ï¼‰
                const data = {
                    rowNum: rowNum,
                    category: parts[0] || '',
                    price: parts[1] ? parseFloat(parts[1]) : 0,
                    totalQuantity: parts[2] ? parseInt(parts[2]) : 0,
                    surplus: parts[3] ? parseInt(parts[3]) : 0,
                    totalPrice: parts[4] ? parseFloat(parts[4]) : 0,
                    kunxu: parts[5] || 'ä¸æ†',
                    claimersText: parts[6] || '',
                    imgUrl: parts[7] || defaultImgUrl,
                    isValid: true,
                    errors: []
                };
                
                // 4. æ•°æ®æ ¡éªŒ
                if (!data.category) {
                    data.isValid = false;
                    data.errors.push('å“ç±»ä¸èƒ½ä¸ºç©º');
                }
                if (isNaN(data.price) || data.price < 0) {
                    data.isValid = false;
                    data.errors.push('å•ä»·å¿…é¡»æ˜¯â‰¥0çš„æ•°å­—');
                }
                if (isNaN(data.totalQuantity) || data.totalQuantity < 1) {
                    data.isValid = false;
                    data.errors.push('æ€»æ•°é‡å¿…é¡»æ˜¯â‰¥1çš„æ•´æ•°');
                }
                
                // 5. å¤„ç†è®¤é¢†äºº
                data.claimers = data.claimersText ? 
                    data.claimersText.split('ã€').map(name => name.trim()).filter(name => name) : [];
                
                // 6. è‡ªåŠ¨è®¡ç®—ç¼ºå¤±çš„å­—æ®µ
                data.calculatedTotalPrice = (data.price * data.totalQuantity).toFixed(2);
                data.calculatedSurplus = data.totalQuantity - data.claimers.length;
                
                importPreviewData.push(data);
                
                // æ”¶é›†é”™è¯¯
                if (!data.isValid) {
                    importErrors.push({
                        rowNum: rowNum,
                        errors: data.errors,
                        line: line
                    });
                }
            });
            
            // 4. ç”Ÿæˆé¢„è§ˆè¡¨æ ¼
            previewContainer.style.display = 'block';
            let previewHtml = '';
            
            importPreviewData.forEach(item => {
                const rowClass = item.isValid ? '' : 'style="background: #f8d7da;"';
                previewHtml += `
                    <div ${rowClass} style="display: flex; border-bottom: 1px solid #eee; font-size: 14px;">
                        <div style="width: 50px; padding: 8px; border-right: 1px solid #eee; text-align: center;">${item.rowNum}</div>
                        <div style="width: 120px; padding: 8px; border-right: 1px solid #eee;">${item.category || '-'}</div>
                        <div style="width: 80px; padding: 8px; border-right: 1px solid #eee; text-align: right;">${item.price || 0}</div>
                        <div style="width: 80px; padding: 8px; border-right: 1px solid #eee; text-align: center;">${item.totalQuantity || 0}</div>
                        <div style="width: 80px; padding: 8px; border-right: 1px solid #eee; text-align: center;">${item.calculatedSurplus}</div>
                        <div style="width: 80px; padding: 8px; border-right: 1px solid #eee; text-align: right;">${item.calculatedTotalPrice}</div>
                        <div style="width: 80px; padding: 8px; border-right: 1px solid #eee;">${item.kunxu}</div>
                        <div style="flex: 1; padding: 8px;">${item.claimersText || 'æ— '}</div>
                    </div>
                `;
            });
            
            previewTable.innerHTML = previewHtml;
            
            // 5. æ˜¾ç¤ºé”™è¯¯æç¤º
            if (importErrors.length > 0) {
                errorTips.style.display = 'block';
                errorTips.style.background = '#f8d7da';
                errorTips.style.color = '#721c24';
                
                let errorHtml = `<strong>âŒ å‘ç° ${importErrors.length} è¡Œæ•°æ®é”™è¯¯ï¼š</strong><br>`;
                importErrors.forEach(err => {
                    errorHtml += `ç¬¬ ${err.rowNum} è¡Œï¼š${err.errors.join('ã€')}<br>`;
                });
                errorHtml += '<br><strong>æç¤ºï¼š</strong>é”™è¯¯è¡Œå°†è¢«è·³è¿‡ï¼Œä»…å¯¼å…¥æœ‰æ•ˆæ•°æ®';
                errorTips.innerHTML = errorHtml;
            } else {
                errorTips.style.display = 'block';
                errorTips.style.background = '#d4edda';
                errorTips.style.color = '#155724';
                errorTips.innerHTML = `âœ… æ‰€æœ‰ ${lines.length} è¡Œæ•°æ®æ ¡éªŒé€šè¿‡ï¼Œå¯ä»¥å¯¼å…¥ï¼`;
            }
        }

        // 2. ä¸‹è½½å¯¼å…¥æ¨¡æ¿ï¼ˆæ–¹ä¾¿ç”¨æˆ·å¡«å†™ï¼‰
        function exportImportTemplate() {
            const templateData = [
                {
                    'å“ç±»': 'ç¤ºä¾‹å¾½ç« A',
                    'å•ä»·(å…ƒ)': '15.00',
                    'æ€»æ•°é‡': '5',
                    'å‰©ä½™æ•°é‡(è‡ªåŠ¨è®¡ç®—)': '-',
                    'å“ç±»æ€»ä»·(è‡ªåŠ¨è®¡ç®—)': '-',
                    'æ†åº': 'æ†1',
                    'æ’çš„äººCN': 'å¼ ä¸‰ã€æå››',
                    'å›¾ç‰‡URL': 'https://via.placeholder.com/180'
                },
                {
                    'å“ç±»': 'ç¤ºä¾‹ç«‹ç‰ŒB',
                    'å•ä»·(å…ƒ)': '35.50',
                    'æ€»æ•°é‡': '10',
                    'å‰©ä½™æ•°é‡(è‡ªåŠ¨è®¡ç®—)': '-',
                    'å“ç±»æ€»ä»·(è‡ªåŠ¨è®¡ç®—)': '-',
                    'æ†åº': 'ä¸æ†',
                    'æ’çš„äººCN': 'ç‹äº”',
                    'å›¾ç‰‡URL': ''
                }
            ];
            
            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ’è°·å¯¼å…¥æ¨¡æ¿');
            XLSX.writeFile(wb, 'æ’è°·æ•°æ®å¯¼å…¥æ¨¡æ¿.xlsx');
        }

        // 3. ç¡®è®¤å¯¼å…¥æ•°æ®ï¼ˆæ ¸å¿ƒå¯¼å…¥é€»è¾‘ï¼‰
        function confirmImportData() {
            if (importPreviewData.length === 0) {
                alert('è¯·å…ˆç‚¹å‡»"é¢„è§ˆæ•°æ®"æŒ‰é’®æ ¡éªŒæ•°æ®ï¼');
                return;
            }
            
            // è¿‡æ»¤æœ‰æ•ˆæ•°æ®
            const validData = importPreviewData.filter(item => item.isValid);
            if (validData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å…¥çš„æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥å¹¶ä¿®æ­£é”™è¯¯ï¼');
                return;
            }
            
            // ç¡®è®¤å¯¼å…¥
            if (!confirm(`å³å°†å¯¼å…¥ ${validData.length} æ¡æœ‰æ•ˆæ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                return;
            }
            
            // æ‰§è¡Œå¯¼å…¥
            let addCount = 0;
            let updateCount = 0;
            
            validData.forEach(item => {
                // æŸ¥æ‰¾å·²æœ‰å“ç±»ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
                const existingIndex = guziData.findIndex(
                    g => g.category.toLowerCase() === item.category.toLowerCase()
                );
                
                if (existingIndex !== -1) {
                    // æ›´æ–°å·²æœ‰å“ç±»
                    guziData[existingIndex] = {
                        category: item.category,
                        price: item.price,
                        totalQuantity: item.totalQuantity,
                        kunxu: item.kunxu,
                        imgSrc: item.imgUrl,
                        claimers: item.claimers,
                        stock: item.calculatedSurplus
                    };
                    updateCount++;
                } else {
                    // æ–°å¢å“ç±»
                    guziData.push({
                        category: item.category,
                        price: item.price,
                        totalQuantity: item.totalQuantity,
                        kunxu: item.kunxu,
                        imgSrc: item.imgUrl,
                        claimers: item.claimers,
                        stock: item.calculatedSurplus
                    });
                    addCount++;
                }
            });
            
            // ä¿å­˜æ•°æ®å¹¶åˆ·æ–°é¡µé¢
            saveDataToLocalStorage();
            initEditPageData();
            renderStockPage();
            renderSummaryPage();
            
            // å¯¼å…¥å®Œæˆæç¤º
            alert(`âœ… å¯¼å…¥æˆåŠŸï¼
â€¢ æ–°å¢å“ç±»ï¼š${addCount} æ¡
â€¢ æ›´æ–°å“ç±»ï¼š${updateCount} æ¡
â€¢ æ€»è®¡å¯¼å…¥ï¼š${validData.length} æ¡`);
            
            // æ¸…ç©ºè¾“å…¥æ¡†å’Œé¢„è§ˆ
            document.getElementById('paiGuBatchData').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importErrorTips').style.display = 'none';
            importPreviewData = [];
            importErrors = [];
        }

        // 4. æ¸…ç©ºå¯¼å…¥å†…å®¹
        function clearImportData() {
            document.getElementById('paiGuBatchData').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importErrorTips').style.display = 'none';
            importPreviewData = [];
            importErrors = [];
        }

        // ==================== Excelå¯¼å‡ºåŠŸèƒ½ ====================
        function exportGuziDataToExcel() {
            if (guziData.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }
            
            const exportData = guziData.map(item => {
                const claimedCount = item.claimers ? item.claimers.length : 0;
                const stock = item.totalQuantity - claimedCount;
                const totalPrice = (item.price * item.totalQuantity).toFixed(2);
                const claimersText = item.claimers ? item.claimers.join('ã€') : '';
                
                return {
                    'å“ç±»': item.category,
                    'å•ä»·(å…ƒ)': item.price.toFixed(2),
                    'æ€»æ•°é‡': item.totalQuantity,
                    'å‰©ä½™æ•°é‡': stock,
                    'å“ç±»æ€»ä»·(å…ƒ)': totalPrice,
                    'æ†åº': item.kunxu,
                    'æ’çš„äººCN': claimersText,
                    'å›¾ç‰‡URL': item.imgSrc || ''
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ’è°·æ•°æ®');
            
            XLSX.writeFile(wb, `æ’è°·æ•°æ®_${new Date().toLocaleDateString()}.xlsx`);
        }

        function clearAllGuziDataWithExport() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ’è°·æ•°æ®å—ï¼Ÿæ¸…ç©ºå‰ä¼šè‡ªåŠ¨å¯¼å‡ºå½“å‰æ•°æ®ä½œä¸ºå¤‡ä»½ï¼')) {
                return;
            }
            
            exportGuziDataToExcel();
            
            setTimeout(() => {
                clearLocalStorageData();
                alert('æ•°æ®å·²å¯¼å‡ºå¤‡ä»½ï¼Œæ‰€æœ‰æ’è°·æ•°æ®å·²æ¸…ç©ºï¼');
            }, 500);
        }

        // ==================== ç»“ç®—ç»Ÿè®¡é¡µé¢åŠŸèƒ½ ====================
        function renderSummaryPage() {
            const container = document.getElementById('summary-container');
            container.innerHTML = '';
            
            if (!currentSearchCN && guziData.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">æš‚æ— è°·å­æ•°æ®ï¼Œè¯·å…ˆæ·»åŠ </div>';
                return;
            }
            
            if (!currentSearchCN) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">è¯·è¾“å…¥CNåç§°æŸ¥è¯¢ç»“ç®—ä¿¡æ¯</div>';
                return;
            }
            
            let totalAmount = 0;
            const summaryItems = [];
            
            guziData.forEach(item => {
                if (!item.claimers || item.claimers.length === 0) return;
                
                const count = item.claimers.filter(name => name === currentSearchCN).length;
                if (count > 0) {
                    const amount = count * item.price;
                    totalAmount += amount;
                    summaryItems.push({
                        category: item.category,
                        count: count,
                        price: item.price,
                        amount: amount
                    });
                }
            });
            
            if (summaryItems.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:20px; color:#666;">CNã€${currentSearchCN}ã€‘æš‚æ— è®¤é¢†è®°å½•</div>`;
                return;
            }
            
            let html = `<div class="summary-card">`;
            html += `<h3>CNï¼š${currentSearchCN} - è®¤é¢†ç»Ÿè®¡</h3>`;
            summaryItems.forEach(item => {
                html += `
                    <div class="summary-item">
                        <span>${item.category} Ã— ${item.count}ä»¶</span>
                        <span>Â¥${item.amount.toFixed(2)} (å•ä»·ï¼šÂ¥${item.price.toFixed(2)})</span>
                    </div>
                `;
            });
            html += `<div class="summary-total">æ€»è®¡ï¼šÂ¥${totalAmount.toFixed(2)}</div>`;
            html += `</div>`;
            
            container.innerHTML = html;
        }

        function searchCN() {
            currentSearchCN = document.getElementById('cnSearchInput').value.trim();
            renderSummaryPage();
        }

        function resetSearch() {
            currentSearchCN = '';
            document.getElementById('cnSearchInput').value = '';
            renderSummaryPage();
        }

        // ==================== åº“å­˜å¡ç‰‡åŠŸèƒ½ ====================
        function renderStockPage() {
            const stockContainer = document.getElementById('stock-container');
            const totalCard = document.getElementById('stock-total-card').querySelector('.stock-total-amount');
            stockContainer.innerHTML = '';
            
            // è®¡ç®—åº“å­˜æ€»é‡‘é¢
            let totalAmount = 0;
            guziData.forEach(item => {
                const claimedCount = item.claimers ? item.claimers.length : 0;
                const stock = item.totalQuantity - claimedCount;
                totalAmount += item.price * stock;
            });
            totalCard.textContent = `Â¥${totalAmount.toFixed(2)}`;
            
            if (guziData.length === 0) {
                stockContainer.innerHTML = `<div style="grid-column: 1 / -1; text-align:center; color:#666; padding:50px;">æš‚æ— è°·å­æ•°æ®ï¼Œè¯·å…ˆæ·»åŠ </div>`;
                return;
            }
            
            // æ¸²æŸ“æ¯ä¸ªåº“å­˜å¡ç‰‡
            guziData.forEach((item, index) => {
                const claimedCount = item.claimers ? item.claimers.length : 0;
                const stock = item.totalQuantity - claimedCount;
                
                // ç»Ÿè®¡è®¤é¢†äººåŠæ•°é‡
                const claimersCount = {};
                if (item.claimers && item.claimers.length > 0) {
                    item.claimers.forEach(cn => {
                        claimersCount[cn] = (claimersCount[cn] || 0) + 1;
                    });
                }
                // ç”Ÿæˆè®¤é¢†äººç»Ÿè®¡æ–‡æœ¬ï¼ˆå¦‚ï¼šå¼ ä¸‰Ã—2ã€æå››Ã—1ï¼‰
                let claimersStats = '';
                if (Object.keys(claimersCount).length > 0) {
                    claimersStats = Object.entries(claimersCount).map(([cn, count]) => `${cn}Ã—${count}`).join('ã€');
                } else {
                    claimersStats = 'æš‚æ— è®¤é¢†äºº';
                }
                
                // åˆ›å»ºå¡ç‰‡
                const card = document.createElement('div');
                card.className = `stock-card ${stock <= 0 ? 'out-of-stock' : ''}`;
                card.dataset.index = index;
                card.dataset.stockStatus = stock > 0 ? 'inStock' : 'outOfStock';
                card.dataset.category = item.category.toLowerCase();
                card.dataset.kunxu = item.kunxu.toLowerCase();
                
                // å¡ç‰‡å†…å®¹ï¼ˆåŒºåˆ†æœ‰åº“å­˜/å·²å”®ç½„ï¼‰
                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front">
                            ${item.kunxu !== 'ä¸æ†' ? `<div class="kunxu-tag">${item.kunxu}</div>` : ''}
                            <img src="${item.imgSrc || defaultImgUrl}" alt="${item.category}">
                            <div class="category-name">${item.category}</div>
                            <div class="stock-num">${stock}</div>
                            <div class="stock-status">${stock > 0 ? 'æœ‰åº“å­˜' : 'å·²å”®ç½„'}</div>
                            <div class="price-info">å•ä»·ï¼šÂ¥${item.price.toFixed(2)}</div>
                        </div>
                        <div class="card-back">
                            <button class="close-btn" onclick="flipCard(${index})">Ã—</button>
                            <h3>${item.category} - è®¤é¢†ä¿¡æ¯</h3>
                            ${stock > 0 ? `
                                <!-- æœ‰åº“å­˜ï¼šæ˜¾ç¤ºè®¤é¢†è¡¨å• -->
                                <div class="claim-form-group">
                                    <label>CNåç§°</label>
                                    <input type="text" class="claim-input" id="cn-${index}" placeholder="è¯·è¾“å…¥è®¤é¢†äººCN">
                                </div>
                                <div class="claim-form-group">
                                    <label>è®¤é¢†æ•°é‡</label>
                                    <input type="number" class="quantity-input" id="quantity-${index}" min="1" max="${stock}" value="1">
                                    <div class="quantity-tip">å‰©ä½™åº“å­˜ï¼š${stock} ä»¶</div>
                                </div>
                                <button class="claim-btn" onclick="submitClaim(${index})">
                                    ç¡®è®¤è®¤é¢†
                                </button>
                            ` : `
                                <!-- å·²å”®ç½„ï¼šæ˜¾ç¤ºè®¤é¢†äººç»Ÿè®¡ -->
                                <div class="claim-form-group" style="margin-top: 20px;">
                                    <label>å·²è®¤é¢†äººç»Ÿè®¡</label>
                                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px; width: 100%; min-height: 100px;">
                                        ${claimersStats}
                                    </div>
                                </div>
                                <div class="claim-form-group">
                                    <label>æ€»è®¤é¢†æ•°é‡</label>
                                    <div style="font-size: 18px; font-weight: bold;">${claimedCount} / ${item.totalQuantity} ä»¶</div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
                // æ‰€æœ‰å¡ç‰‡éƒ½å¯ç‚¹å‡»ç¿»è½¬ï¼ˆåŒ…æ‹¬å·²å”®ç½„ï¼‰
                const cardFront = card.querySelector('.card-front');
                cardFront.addEventListener('click', () => flipCard(index));
                
                stockContainer.appendChild(card);
            });
            
            applyStockFilterAndSearch();
        }

        function searchStock() {
            currentStockSearch = document.getElementById('stockSearchInput').value.trim().toLowerCase();
            applyStockFilterAndSearch();
        }

        function resetStockSearch() {
            currentStockSearch = '';
            document.getElementById('stockSearchInput').value = '';
            applyStockFilterAndSearch();
        }

        function filterStock(filterType) {
            currentStockFilter = filterType;
            
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            if (filterType === 'all') document.getElementById('filterAllBtn').classList.add('active');
            else if (filterType === 'inStock') document.getElementById('filterInStockBtn').classList.add('active');
            else if (filterType === 'outOfStock') document.getElementById('filterOutOfStockBtn').classList.add('active');
            
            applyStockFilterAndSearch();
        }

        function applyStockFilterAndSearch() {
            const allCards = document.querySelectorAll('.stock-card');
            
            allCards.forEach(card => {
                card.classList.remove('visible');
                
                const matchesFilter = currentStockFilter === 'all' || card.dataset.stockStatus === currentStockFilter;
                let matchesSearch = true;
                if (currentStockSearch) {
                    const category = card.dataset.category;
                    const kunxu = card.dataset.kunxu;
                    matchesSearch = category.includes(currentStockSearch) || kunxu.includes(currentStockSearch);
                }
                
                if (matchesFilter && matchesSearch) {
                    card.classList.add('visible');
                }
            });
            
            const visibleCards = document.querySelectorAll('.stock-card.visible');
            if (visibleCards.length === 0 && guziData.length > 0) {
                document.getElementById('stock-container').insertAdjacentHTML('beforeend', 
                    `<div style="grid-column: 1 / -1; text-align:center; color:#666; padding:50px;">æœªæ‰¾åˆ°åŒ¹é…çš„è°·å­æ•°æ®</div>`);
            }
        }

        function flipCard(index) {
            const card = document.querySelector(`.stock-card[data-index="${index}"]`);
            if (card) {
                card.classList.toggle('flipped');
                // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆå¦‚æœæ˜¯å…³é—­å¡ç‰‡ï¼‰
                if (!card.classList.contains('flipped')) {
                    const cnInput = document.getElementById(`cn-${index}`);
                    const quantityInput = document.getElementById(`quantity-${index}`);
                    if (cnInput) cnInput.value = '';
                    if (quantityInput) quantityInput.value = 1;
                }
            }
        }

        function submitClaim(index) {
            const cnInput = document.getElementById(`cn-${index}`);
            const quantityInput = document.getElementById(`quantity-${index}`);
            const cnName = cnInput.value.trim();
            const quantity = parseInt(quantityInput.value);
            const item = guziData[index];
            const claimedCount = item.claimers ? item.claimers.length : 0;
            const stock = item.totalQuantity - claimedCount;
            
            if (!cnName) {
                alert('è¯·è¾“å…¥è®¤é¢†äººCNåç§°ï¼');
                return;
            }
            if (isNaN(quantity) || quantity < 1 || quantity > stock) {
                alert(`è®¤é¢†æ•°é‡å¿…é¡»åœ¨1-${stock}ä¹‹é—´ï¼`);
                return;
            }
            
            // ç”Ÿæˆè®¤é¢†åˆ—è¡¨ï¼ˆæ”¯æŒå•CNè®¤é¢†å¤šä¸ªï¼‰
            const claimList = Array(quantity).fill(cnName);
            item.claimers = item.claimers || [];
            item.claimers.push(...claimList);
            
            saveDataToLocalStorage();
            renderStockPage();
            initEditPageData();
            renderSummaryPage();
            
            flipCard(index);
            alert(`è®¤é¢†æˆåŠŸï¼${cnName} è®¤é¢†äº† ${quantity} ä»¶ ${item.category}`);
        }

        function quickAddGuzi() {
            switchPage('upload-page');
            document.getElementById('category').focus();
        }
    </script>
</body>
</html>
