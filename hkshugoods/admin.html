<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ’è°·ç®¡ç†ç³»ç»Ÿï¼ˆç®¡ç†å‘˜ç«¯ï¼‰</title>
    <style>
        /* å…¨å±€é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1500px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #666;
        }
        .tab.active {
            color: #2c3e50;
            border-bottom: 2px solid #2c3e50;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .upload-btn, .search-btn, .pai-gu-search-btn {
            background-color: #007bff;
            color: white;
        }
        .upload-btn:hover, .search-btn:hover, .pai-gu-search-btn:hover {
            background-color: #0056b3;
        }
        .reset-search-btn, .pai-gu-reset-btn {
            background-color: #6c757d;
            color: white;
            margin-left: 10px;
        }
        .reset-search-btn:hover, .pai-gu-reset-btn:hover {
            background-color: #5a6268;
        }
        .export-btn {
            background-color: #28a745;
            color: white;
            margin-right: 10px;
        }
        .export-btn:hover {
            background-color: #218838;
        }
        .add-new-row-btn {
            background-color: #17a2b8;
            color: white;
            margin-right: 10px;
        }
        .add-new-row-btn:hover {
            background-color: #138496;
        }
        .clear-all-btn {
            background-color: #dc3545;
            color: white;
        }
        .clear-all-btn:hover {
            background-color: #c82333;
        }
        /* ç­›é€‰æŒ‰é’®æ ·å¼ */
        .filter-btn {
            background-color: #ffc107;
            color: #212529;
            margin-left: 10px;
        }
        .filter-btn:hover {
            background-color: #e0a800;
        }
        .filter-btn.active {
            background-color: #fd7e14;
            color: white;
        }
        /* ä¸Šä¼ é¡µé¢æ ·å¼ */
        .upload-container {
            margin-top: 20px;
        }
        .upload-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .upload-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
        }
        .upload-tab.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }
        .upload-panel {
            display: none;
        }
        .upload-panel.active {
            display: block;
        }
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 600px;
        }
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group.label-top {
            width: 100%;
        }
        .batch-tips {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
            border-left: 3px solid #007bff;
        }
        .batch-textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
            resize: vertical;
        }
        /* ç¼–è¾‘é¡µé¢æ ·å¼ */
        .edit-page-container {
            margin-top: 20px;
        }
        .edit-tips {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }
        .edit-sub-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .edit-sub-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
        }
        .edit-sub-tab.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }
        .edit-sub-panel {
            display: none;
        }
        .edit-sub-panel.active {
            display: block;
        }
        .edit-table-wrap {
            overflow-x: auto;
            margin-top: 15px;
        }
        .edit-guzi-table {
            width: 100%;
            border-collapse: collapse;
        }
        .edit-guzi-table th, .edit-guzi-table td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            text-align: left;
        }
        .edit-guzi-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .edit-guzi-table td input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .col-select {
            width: 50px;
            text-align: center;
        }
        .col-category {
            min-width: 120px;
        }
        .col-img {
            min-width: 200px;
        }
        .col-price, .col-total-quantity, .col-surplus, .col-total-price {
            width: 100px;
            text-align: right;
        }
        .col-kunxu {
            width: 80px;
        }
        .col-claimer {
            min-width: 150px;
        }
        /* å…¨å±€å¿«é€Ÿæ·»åŠ æŒ‰é’® */
        .quick-add-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            font-size: 24px;
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 999;
        }
        .quick-add-btn:hover {
            background-color: #218838;
        }
        /* åŒæ­¥æç¤º */
        .sync-tip {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border-radius: 4px;
            z-index: 1000;
            display: none;
        }
    </style>
    <!-- å¼•å…¥SheetJSåº“ç”¨äºExcelå¯¼å‡º -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- å¼•å…¥Gistå·¥å…·åº“ -->
    <script src="gist-utils.js"></script>
</head>
<body>
    <div class="container">
        <!-- æ ‡ç­¾é¡µåˆ‡æ¢ï¼ˆä»…ä¿ç•™ä¸Šä¼ ã€ç¼–è¾‘ï¼‰ -->
        <div class="tabs">
            <button class="tab active" onclick="switchPage('upload-page')">ä¸Šä¼ è°·å­</button>
            <button class="tab" onclick="switchPage('edit-page')">ç¼–è¾‘æ’è°·æ•°æ®</button>
        </div>

        <!-- ä¸Šä¼ è°·å­é¡µé¢ -->
        <div id="upload-page" class="page active">
            <h2>ä¸Šä¼ è°·å­ä¿¡æ¯</h2>
            <div class="upload-container">
                <div class="upload-tabs">
                    <button class="upload-tab active" onclick="switchUploadTab('single')">å•ä¸ªæ·»åŠ </button>
                    <button class="upload-tab" onclick="switchUploadTab('batch')">æ‰¹é‡ç²˜è´´æ·»åŠ </button>
                </div>
                <div id="single-upload-panel" class="upload-panel active">
                    <form class="upload-form" id="guziUploadForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="category">å“ç±»</label>
                                <input type="text" id="category" placeholder="å¾½ç« Aã€ç«‹ç‰ŒB" required>
                            </div>
                            <div class="form-group">
                                <label for="price">å•ä»·(å…ƒ)</label>
                                <input type="number" id="price" step="0.01" min="0" placeholder="15ã€35.5" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="totalQuantity">æ€»æ•°é‡</label>
                                <input type="number" id="totalQuantity" min="1" placeholder="5ã€10" required>
                            </div>
                            <div class="form-group">
                                <label for="kunxu">æ†åºï¼ˆé€‰å¡«ï¼‰</label>
                                <input type="text" id="kunxu" placeholder="æ†1ã€æ†2ï¼Œç©ºç™½=ä¸æ†">
                            </div>
                        </div>
                        <div class="form-group label-top">
                            <label for="imgUrl">è°·å­å›¾ç‰‡URLï¼ˆå¯é€‰ï¼Œç•™ç©ºç”¨é»˜è®¤å›¾ï¼‰</label>
                            <input type="text" id="imgUrl" placeholder="https://xxx.jpg">
                        </div>
                        <button type="submit" class="btn upload-btn">æ·»åŠ åˆ°æ’è°·åˆ—è¡¨</button>
                    </form>
                </div>
                <div id="batch-upload-panel" class="upload-panel">
                    <div class="batch-tips">
                        ğŸ’¡ æ‰¹é‡æ·»åŠ æ ¼å¼è¯´æ˜ï¼š<br>
                        1. æ¯è¡Œä¸€æ¡æ•°æ®ï¼Œåˆ—ä¹‹é—´ç”¨ã€åˆ¶è¡¨ç¬¦(Tab)ã€‘åˆ†éš”ï¼ˆç›´æ¥å¤åˆ¶Excelè¡Œå³å¯ï¼‰<br>
                        2. åˆ—é¡ºåºï¼šå“ç±»	å•ä»·	æ€»æ•°é‡	æ†åºï¼ˆé€‰å¡«ï¼‰	å›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰<br>
                        3. ç¤ºä¾‹ï¼š<br>
                        å¾½ç« A	15	5	æ†1	https://via.placeholder.com/80<br>
                        ç«‹ç‰ŒB	35.5	10		<!-- ç©ºç™½è¡¨ç¤ºä¸æ† -->
                        æŒ‚ä»¶C	20	8			<!-- æ†åºå’Œå›¾ç‰‡éƒ½ç•™ç©º -->
                    </div>
                    <textarea class="batch-textarea" id="batchData" placeholder="è¯·ç²˜è´´æ‰¹é‡æ•°æ®ï¼ˆæ”¯æŒç›´æ¥å¤åˆ¶Excelå†…å®¹ï¼‰"></textarea>
                    <button class="btn upload-btn" onclick="batchAddGuzi()">æ‰¹é‡æ·»åŠ åˆ°æ’è°·åˆ—è¡¨</button>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘æ’è°·æ•°æ®é¡µé¢ -->
        <div id="edit-page" class="page">
            <div class="edit-page-container">
                <h2>ç¼–è¾‘æ’è°·æ•°æ®</h2>
                <div class="edit-tips">
                    ğŸ’¡ æ“ä½œæç¤ºï¼š1. ç‚¹å‡»å•å…ƒæ ¼å¯ç›´æ¥ç¼–è¾‘ï¼›2. æ”¯æŒä»Excelå¤åˆ¶å†…å®¹ç›´æ¥ç²˜è´´åˆ°è¡¨æ ¼ï¼›3. å“ç±»æ€»ä»·ä¼šæ ¹æ®å•ä»·å’Œæ€»æ•°é‡è‡ªåŠ¨è®¡ç®—ï¼›4. å‰©ä½™æ•°é‡ä¼šæ ¹æ®æ’çš„äººCNæ•°é‡è‡ªåŠ¨è®¡ç®—ï¼›5. æ’çš„äººCNæ”¯æŒç¼–è¾‘ï¼ˆå¤šä¸ªåå­—ç”¨é¡¿å·åˆ†éš”ï¼‰ï¼›6. æ‰€æœ‰ä¿®æ”¹ä¼šè‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯ï¼›7. å¯åˆ é™¤å•è¡Œæ•°æ®æˆ–æ¸…ç©ºæ‰€æœ‰æ•°æ®
                </div>
                <div class="edit-sub-tabs">
                    <button class="edit-sub-tab active" onclick="switchEditSubTab('table-edit')">è¡¨æ ¼ç¼–è¾‘</button>
                    <button class="edit-sub-tab" onclick="switchEditSubTab('batch-claim')">æ‰¹é‡è®¤é¢†å¯¼å…¥</button>
                </div>
                <div id="table-edit-panel" class="edit-sub-panel active">
                    <button class="btn export-btn" onclick="exportGuziDataToExcel()">å¯¼å‡ºæ’è°·æ•°æ®ä¸ºExcel</button>
                    <button class="btn add-new-row-btn" onclick="addNewEditRow()">æ–°å¢ä¸€è¡Œ</button>
                    <button class="btn clear-all-btn" onclick="clearAllGuziDataWithExport()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                    <div class="edit-table-wrap">
                        <table id="edit-guzi-table" class="edit-guzi-table">
                            <thead>
                                <tr>
                                    <th class="col-select"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" disabled></th>
                                    <th class="col-category">å“ç±»</th>
                                    <th class="col-img">è°·å­å›¾ç‰‡URL</th>
                                    <th class="col-price">å•ä»·</th>
                                    <th class="col-total-quantity">æ€»æ•°é‡</th>
                                    <th class="col-surplus">å‰©ä½™æ•°é‡</th>
                                    <th class="col-total-price">å“ç±»æ€»ä»·</th>
                                    <th class="col-kunxu">æ†åº</th>
                                    <th class="col-claimer">æ’çš„äººCN</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="edit-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <!-- æ‰¹é‡è®¤é¢†å¯¼å…¥é¢æ¿ -->
                <div id="batch-claim-panel" class="edit-sub-panel">
                    <div class="pai-gu-batch-container">
                        <h3 style="margin-bottom: 10px; color: #2c3e50; font-size: 16px;">æ‰¹é‡å¯¼å…¥æ’è°·è®¤é¢†æ•°æ®</h3>
                        
                        <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            <div style="font-weight: 500; margin-bottom: 8px;">ğŸ“Œ æ¨èå¯¼å…¥æ–¹å¼ï¼š</div>
                            <ol style="margin-left: 20px; line-height: 1.6; color: #666;">
                                <li>å…ˆå¯¼å‡ºExcelæ¨¡æ¿ â†’ å¡«å†™æ•°æ® â†’ å¤åˆ¶Excelå†…å®¹ç²˜è´´åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†</li>
                                <li>æ”¯æŒä¸¤ç§åˆ†éš”ç¬¦ï¼š<strong>åˆ¶è¡¨ç¬¦ï¼ˆExcelé»˜è®¤ï¼‰</strong> æˆ– <strong>é€—å·/ç«–çº¿ï¼ˆ|ï¼‰</strong></li>
                                <li>åˆ—é¡ºåºï¼šå“ç±»,å•ä»·,æ€»æ•°é‡,å‰©ä½™æ•°é‡,å“ç±»æ€»ä»·,æ†åº,æ’çš„äººCN,å›¾ç‰‡URLï¼ˆæ€»ä»·å’Œå‰©ä½™æ•°é‡ä¼šè‡ªåŠ¨è®¡ç®—ï¼‰</li>
                            </ol>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                            <label style="font-weight: 500;">åˆ†éš”ç¬¦ç±»å‹ï¼š</label>
                            <select id="delimiterType" class="btn" style="padding: 6px 12px;">
                                <option value="tab">åˆ¶è¡¨ç¬¦ï¼ˆExcelå¤åˆ¶ï¼‰</option>
                                <option value="comma">é€—å·ï¼ˆ,ï¼‰</option>
                                <option value="pipe">ç«–çº¿ï¼ˆ|ï¼‰</option>
                            </select>
                        </div>
                        
                        <textarea class="batch-textarea" id="paiGuBatchData" placeholder="è¯·ç²˜è´´æ•°æ®ï¼ˆæ”¯æŒExcelå¤åˆ¶/æ‰‹åŠ¨è¾“å…¥ï¼‰
ç¤ºä¾‹1ï¼ˆåˆ¶è¡¨ç¬¦ï¼‰ï¼šå¾½ç« A	15	5	3	75	æ†1	å¼ ä¸‰ã€æå››	https://xxx.jpg
ç¤ºä¾‹2ï¼ˆé€—å·ï¼‰ï¼šå¾½ç« B,35.5,10,8,355,ä¸æ†,ç‹äº”,
ç¤ºä¾‹3ï¼ˆç«–çº¿ï¼‰ï¼šæŒ‚ä»¶C|20|8|8|160|ä¸æ†||"></textarea>
                        
                        <div id="importPreview" style="margin: 15px 0; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; display: none;">
                            <div style="background: #e9ecef; padding: 8px 12px; font-weight: 500; border-bottom: 1px solid #ddd;">
                                å¯¼å…¥é¢„è§ˆï¼ˆç‚¹å‡»è¡Œå¯æŸ¥çœ‹è¯¦æƒ…ï¼‰
                            </div>
                            <div id="previewTable"></div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn upload-btn" onclick="previewImportData()">ğŸ“‹ é¢„è§ˆæ•°æ®</button>
                            <button class="btn export-btn" onclick="exportImportTemplate()">ğŸ“¥ ä¸‹è½½å¯¼å…¥æ¨¡æ¿</button>
                            <button class="btn" style="background: #28a745; color: white;" onclick="confirmImportData()">âœ… ç¡®è®¤å¯¼å…¥</button>
                            <button class="btn reset-search-btn" onclick="clearImportData()">ğŸ—‘ï¸ æ¸…ç©ºå†…å®¹</button>
                        </div>
                        
                        <div id="importErrorTips" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¨å±€å¿«é€Ÿæ·»åŠ æŒ‰é’® -->
    <button class="quick-add-btn" onclick="quickAddGuzi()">+</button>
    
    <!-- åŒæ­¥æç¤º -->
    <div class="sync-tip" id="syncTip">æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯ï¼</div>
    
    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let guziData = [];          
        let claimRecords = [];      
        const defaultImgUrl = "https://via.placeholder.com/180";
        let importPreviewData = []; // å¯¼å…¥é¢„è§ˆæ•°æ®ç¼“å­˜
        let importErrors = [];      // å¯¼å…¥é”™è¯¯ä¿¡æ¯

        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // ä»GiståŠ è½½æ•°æ®
            const data = await fetchGuziDataFromGist();
            guziData = data.guziData;
            claimRecords = data.claimRecords;
            
            document.getElementById('guziUploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addGuziFromForm();
            });
            
            initEditPageData();
            
            // å›è½¦æœç´¢ç­‰åŸæœ‰äº‹ä»¶
            document.getElementById('cnSearchInput') && document.getElementById('cnSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchCN();
            });
        });

        // ==================== æ•°æ®åŒæ­¥å‡½æ•°ï¼ˆæ›¿æ¢åŸæœ¬åœ°å­˜å‚¨ï¼‰ ====================
        function saveDataToLocalStorage() {
            // æ›¿æ¢ä¸ºåŒæ­¥åˆ°Gist
            syncGuziDataToGist(guziData, claimRecords);
            showSyncTip();
        }

        function clearLocalStorageData() {
            try {
                // æ¸…ç©ºGistæ•°æ®
                syncGuziDataToGist([], []);
                guziData = [];
                claimRecords = [];
                initEditPageData();
                alert("æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼");
            } catch (error) {
                console.error("âŒ æ¸…ç©ºäº‘ç«¯æ•°æ®å¼‚å¸¸ï¼š", error);
                alert("æ¸…ç©ºæ•°æ®å¤±è´¥ï¼");
            }
        }

        // ==================== è¾…åŠ©å‡½æ•° ====================
        function showSyncTip() {
            const tip = document.getElementById('syncTip');
            tip.style.display = "block";
            setTimeout(() => tip.style.display = "none", 2000);
        }

        // ==================== é¡µé¢åˆ‡æ¢å‡½æ•° ====================
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
        }

        function switchUploadTab(tabType) {
            document.querySelectorAll('.upload-panel').forEach(panel => panel.classList.remove('active'));
            document.querySelectorAll('.upload-tab').forEach(tab => tab.classList.remove('active'));
            
            if (tabType === 'single') {
                document.getElementById('single-upload-panel').classList.add('active');
            } else {
                document.getElementById('batch-upload-panel').classList.add('active');
            }
            event.target.classList.add('active');
        }

        function switchEditSubTab(tabType) {
            document.querySelectorAll('.edit-sub-panel').forEach(panel => panel.classList.remove('active'));
            document.querySelectorAll('.edit-sub-tab').forEach(tab => tab.classList.remove('active'));
            
            if (tabType === 'table-edit') {
                document.getElementById('table-edit-panel').classList.add('active');
            } else {
                document.getElementById('batch-claim-panel').classList.add('active');
            }
            event.target.classList.add('active');
        }

        // ==================== ä¸Šä¼ è°·å­åŠŸèƒ½ ====================
        function addGuziFromForm() {
            const category = document.getElementById('category').value.trim();
            const price = parseFloat(document.getElementById('price').value);
            const totalQuantity = parseInt(document.getElementById('totalQuantity').value);
            const kunxu = document.getElementById('kunxu').value.trim();
            const imgUrl = document.getElementById('imgUrl').value.trim();
            
            if (!category || isNaN(price) || isNaN(totalQuantity) || totalQuantity < 1) {
                alert('è¯·å¡«å†™æ­£ç¡®çš„è°·å­ä¿¡æ¯ï¼');
                return;
            }
            
            const exists = guziData.some(item => item.category === category);
            if (exists) {
                alert(`å“ç±»ã€${category}ã€‘å·²å­˜åœ¨ï¼Œè¯·ä¿®æ”¹å“ç±»åç§°ï¼`);
                return;
            }
            
            guziData.push({
                category,
                price,
                totalQuantity,
                kunxu: kunxu || 'ä¸æ†',
                imgSrc: imgUrl || defaultImgUrl,
                claimers: [],
                stock: totalQuantity
            });
            
            saveDataToLocalStorage(); // å®é™…æ˜¯åŒæ­¥åˆ°Gist
            initEditPageData();
            
            document.getElementById('guziUploadForm').reset();
            alert(`è°·å­ã€${category}ã€‘æ·»åŠ æˆåŠŸï¼`);
        }

        function batchAddGuzi() {
            const batchData = document.getElementById('batchData').value.trim();
            if (!batchData) {
                alert('è¯·ç²˜è´´æ‰¹é‡æ•°æ®ï¼');
                return;
            }
            
            const lines = batchData.split('\n');
            let successCount = 0;
            let existsCount = 0;
            
            lines.forEach(line => {
                const parts = line.split('\t').map(part => part.trim());
                if (parts.length < 3) return;
                
                const category = parts[0];
                const price = parseFloat(parts[1]);
                const totalQuantity = parseInt(parts[2]);
                const kunxu = parts[3] || 'ä¸æ†';
                const imgUrl = parts[4] || defaultImgUrl;
                
                if (!category || isNaN(price) || isNaN(totalQuantity) || totalQuantity < 1) {
                    return;
                }
                
                if (guziData.some(item => item.category === category)) {
                    existsCount++;
                    return;
                }
                
                guziData.push({
                    category, price, totalQuantity, kunxu, imgSrc: imgUrl, claimers: [], stock: totalQuantity
                });
                successCount++;
            });
            
            if (successCount > 0) {
                saveDataToLocalStorage(); // åŒæ­¥åˆ°Gist
                initEditPageData();
                const msg = `æ‰¹é‡æ·»åŠ æˆåŠŸï¼å…±æ·»åŠ ${successCount}æ¡è°·å­æ•°æ®` + (existsCount > 0 ? `ï¼Œ${existsCount}æ¡å“ç±»å·²å­˜åœ¨è·³è¿‡` : '');
                alert(msg);
                document.getElementById('batchData').value = '';
            } else {
                alert(existsCount > 0 ? 'æ‰€æœ‰å“ç±»éƒ½å·²å­˜åœ¨ï¼' : 'æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥æ ¼å¼ï¼');
            }
        }

        // ==================== ç¼–è¾‘é¡µé¢æ ¸å¿ƒåŠŸèƒ½ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼Œä»…ä¿®æ”¹æ•°æ®ä¿å­˜æ–¹å¼ï¼‰ ====================
        function initEditPageData() {
            // ä¿ç•™åŸæœ‰çš„è¡¨æ ¼æ¸²æŸ“é€»è¾‘ï¼Œä»…å°†ä¿å­˜æ“ä½œæ›¿æ¢ä¸ºåŒæ­¥åˆ°Gist
            const tableBody = document.getElementById('edit-table-body');
            tableBody.innerHTML = '';
            
            guziData.forEach((item, index) => {
                const claimersStr = item.claimers.join('ã€') || '';
                const totalPrice = (item.price * item.totalQuantity).toFixed(2);
                const surplus = item.stock;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-select"><input type="checkbox" class="row-checkbox" data-index="${index}"></td>
                    <td class="col-category" contenteditable="true" onblur="updateGuziData(${index}, 'category', this.innerText)">${item.category}</td>
                    <td class="col-img" contenteditable="true" onblur="updateGuziData(${index}, 'imgSrc', this.innerText)">${item.imgSrc}</td>
                    <td class="col-price" contenteditable="true" onblur="updateGuziData(${index}, 'price', parseFloat(this.innerText))">${item.price}</td>
                    <td class="col-total-quantity" contenteditable="true" onblur="updateGuziData(${index}, 'totalQuantity', parseInt(this.innerText))">${item.totalQuantity}</td>
                    <td class="col-surplus">${surplus}</td>
                    <td class="col-total-price">${totalPrice}</td>
                    <td class="col-kunxu" contenteditable="true" onblur="updateGuziData(${index}, 'kunxu', this.innerText)">${item.kunxu}</td>
                    <td class="col-claimer" contenteditable="true" onblur="updateClaimers(${index}, this.innerText)">${claimersStr}</td>
                    <td><button class="btn clear-all-btn" onclick="deleteGuziRow(${index})">åˆ é™¤</button></td>
                `;
                tableBody.appendChild(tr);
            });
            
            document.getElementById('selectAllCheckbox').disabled = guziData.length === 0;
        }

        function updateGuziData(index, key, value) {
            if (value === undefined || value === null) return;
            guziData[index][key] = value;
            // è‡ªåŠ¨è®¡ç®—æ€»ä»·å’Œåº“å­˜
            guziData[index].totalPrice = (guziData[index].price * guziData[index].totalQuantity).toFixed(2);
            saveDataToLocalStorage(); // åŒæ­¥åˆ°Gist
            initEditPageData(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼
        }

        function updateClaimers(index, claimersStr) {
            const claimers = claimersStr ? claimersStr.split('ã€').map(name => name.trim()) : [];
            guziData[index].claimers = claimers;
            // æ›´æ–°åº“å­˜
            guziData[index].stock = guziData[index].totalQuantity - claimers.length;
            saveDataToLocalStorage(); // åŒæ­¥åˆ°Gist
            initEditPageData();
        }

        function deleteGuziRow(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™è¡Œæ•°æ®å—ï¼Ÿ')) {
                guziData.splice(index, 1);
                saveDataToLocalStorage(); // åŒæ­¥åˆ°Gist
                initEditPageData();
            }
        }

        function addNewEditRow() {
            guziData.push({
                category: 'æ–°å¢å“ç±»',
                price: 0,
                totalQuantity: 1,
                kunxu: 'ä¸æ†',
                imgSrc: defaultImgUrl,
                claimers: [],
                stock: 1
            });
            saveDataToLocalStorage(); // åŒæ­¥åˆ°Gist
            initEditPageData();
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        function clearAllGuziDataWithExport() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ¸…ç©ºå‰å»ºè®®å…ˆå¯¼å‡ºæ•°æ®ï¼')) {
                exportGuziDataToExcel(); // å…ˆå¯¼å‡º
                clearLocalStorageData(); // æ¸…ç©ºGistæ•°æ®
            }
        }

        function exportGuziDataToExcel() {
            // ä¿ç•™åŸæœ‰Excelå¯¼å‡ºé€»è¾‘
            const wsData = guziData.map(item => [
                item.category,
                item.price,
                item.totalQuantity,
                item.stock,
                (item.price * item.totalQuantity).toFixed(2),
                item.kunxu,
                item.claimers.join('ã€'),
                item.imgSrc
            ]);
            wsData.unshift(['å“ç±»', 'å•ä»·', 'æ€»æ•°é‡', 'å‰©ä½™æ•°é‡', 'å“ç±»æ€»ä»·', 'æ†åº', 'æ’çš„äººCN', 'å›¾ç‰‡URL']);
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ’è°·æ•°æ®');
            XLSX.writeFile(wb, `æ’è°·æ•°æ®_${new Date().toLocaleDateString()}.xlsx`);
        }

        // æ‰¹é‡è®¤é¢†å¯¼å…¥ç›¸å…³å‡½æ•°ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼Œä»…ä¿®æ”¹æ•°æ®ä¿å­˜ï¼‰
        function previewImportData() {
            const data = document.getElementById('paiGuBatchData').value.trim();
            if (!data) {
                alert('è¯·å…ˆç²˜è´´å¯¼å…¥æ•°æ®ï¼');
                return;
            }
            
            importErrors = [];
            importPreviewData = [];
            const delimiter = document.getElementById('delimiterType').value;
            const lines = data.split('\n');
            
            lines.forEach((line, lineNum) => {
                if (!line.trim()) return;
                let parts = [];
                switch(delimiter) {
                    case 'tab': parts = line.split('\t').map(p => p.trim()); break;
                    case 'comma': parts = line.split(',').map(p => p.trim()); break;
                    case 'pipe': parts = line.split('|').map(p => p.trim()); break;
                }
                
                // æ ¡éªŒæ•°æ®
                if (parts.length < 7) {
                    importErrors.push(`ç¬¬${lineNum+1}è¡Œï¼šåˆ—æ•°ä¸è¶³ï¼ˆè‡³å°‘7åˆ—ï¼‰`);
                    return;
                }
                
                const [category, price, totalQuantity, surplus, totalPrice, kunxu, claimersStr, imgUrl] = parts;
                if (isNaN(parseFloat(price)) || isNaN(parseInt(totalQuantity))) {
                    importErrors.push(`ç¬¬${lineNum+1}è¡Œï¼šå•ä»·/æ€»æ•°é‡å¿…é¡»ä¸ºæ•°å­—`);
                    return;
                }
                
                importPreviewData.push({
                    category,
                    price: parseFloat(price),
                    totalQuantity: parseInt(totalQuantity),
                    surplus: parseInt(surplus) || 0,
                    totalPrice: parseFloat(totalPrice) || (parseFloat(price) * parseInt(totalQuantity)),
                    kunxu: kunxu || 'ä¸æ†',
                    claimers: claimersStr ? claimersStr.split('ã€').map(n => n.trim()) : [],
                    imgSrc: imgUrl || defaultImgUrl,
                    stock: parseInt(surplus) || (parseInt(totalQuantity) - (claimersStr ? claimersStr.split('ã€').length : 0))
                });
            });
            
            // æ¸²æŸ“é¢„è§ˆ
            const previewEl = document.getElementById('importPreview');
            const previewTableEl = document.getElementById('previewTable');
            previewTableEl.innerHTML = '';
            
            if (importErrors.length > 0) {
                document.getElementById('importErrorTips').style.display = 'block';
                document.getElementById('importErrorTips').style.backgroundColor = '#f8d7da';
                document.getElementById('importErrorTips').style.color = '#721c24';
                document.getElementById('importErrorTips').innerText = `å¯¼å…¥é”™è¯¯ï¼š\n${importErrors.join('\n')}`;
            } else {
                document.getElementById('importErrorTips').style.display = 'none';
            }
            
            importPreviewData.forEach((item, index) => {
                const div = document.createElement('div');
                div.style.padding = '8px 12px';
                div.style.borderBottom = '1px solid #eee';
                div.innerHTML = `
                    <div><strong>å“ç±»ï¼š</strong>${item.category}</div>
                    <div><strong>å•ä»·ï¼š</strong>${item.price} å…ƒ | <strong>æ€»æ•°é‡ï¼š</strong>${item.totalQuantity} | <strong>å‰©ä½™ï¼š</strong>${item.stock}</div>
                    <div><strong>æ†åºï¼š</strong>${item.kunxu} | <strong>è®¤é¢†äººï¼š</strong>${item.claimers.join('ã€') || 'æ— '}</div>
                `;
                previewTableEl.appendChild(div);
            });
            
            previewEl.style.display = 'block';
        }

        function exportImportTemplate() {
            // å¯¼å‡ºæ¨¡æ¿Excel
            const templateData = [
                ['å“ç±»', 'å•ä»·', 'æ€»æ•°é‡', 'å‰©ä½™æ•°é‡', 'å“ç±»æ€»ä»·', 'æ†åº', 'æ’çš„äººCN', 'å›¾ç‰‡URL'],
                ['å¾½ç« ç¤ºä¾‹', '15', '10', '8', '150', 'æ†1', 'å¼ ä¸‰ã€æå››', 'https://via.placeholder.com/180'],
                ['ç«‹ç‰Œç¤ºä¾‹', '35.5', '5', '5', '177.5', 'ä¸æ†', '', '']
            ];
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å¯¼å…¥æ¨¡æ¿');
            XLSX.writeFile(wb, 'æ’è°·æ•°æ®å¯¼å…¥æ¨¡æ¿.xlsx');
        }

        function confirmImportData() {
            if (importPreviewData.length === 0) {
                alert('æš‚æ— é¢„è§ˆæ•°æ®ï¼Œè¯·å…ˆé¢„è§ˆï¼');
                return;
            }
            
            if (importErrors.length > 0) {
                alert(`å­˜åœ¨å¯¼å…¥é”™è¯¯ï¼Œæ— æ³•å¯¼å…¥ï¼š\n${importErrors.join('\n')}`);
                return;
            }
            
            if (confirm(`ç¡®è®¤å¯¼å…¥${importPreviewData.length}æ¡æ•°æ®å—ï¼Ÿå·²å­˜åœ¨çš„å“ç±»å°†è¢«è¦†ç›–ï¼`)) {
                // åˆå¹¶æ•°æ®ï¼ˆè¦†ç›–å·²æœ‰å“ç±»ï¼Œæ–°å¢ä¸å­˜åœ¨çš„ï¼‰
                importPreviewData.forEach(importItem => {
                    const existingIndex = guziData.findIndex(item => item.category === importItem.category);
                    if (existingIndex >= 0) {
                        guziData[existingIndex] = importItem;
                    } else {
                        guziData.push(importItem);
                    }
                });
                
                saveDataToLocalStorage(); // åŒæ­¥åˆ°Gist
                initEditPageData();
                alert(`æˆåŠŸå¯¼å…¥${importPreviewData.length}æ¡æ•°æ®ï¼`);
                document.getElementById('paiGuBatchData').value = '';
                document.getElementById('importPreview').style.display = 'none';
            }
        }

        function clearImportData() {
            document.getElementById('paiGuBatchData').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importErrorTips').style.display = 'none';
            importPreviewData = [];
            importErrors = [];
        }

        // å¿«é€Ÿæ·»åŠ æŒ‰é’®
        function quickAddGuzi() {
            switchPage('upload-page');
            document.getElementById('category').focus();
        }
    </script>
</body>
</html>
